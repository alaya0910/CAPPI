generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  TRAVELER
  PARTNER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum RiskTolerance {
  LOW
  MEDIUM
  HIGH
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum PartnerType {
  HOTEL
  RESTAURANT
  CLUB
  EXPERIENCE
  TRANSPORT
  SPA
  TOUR_OPERATOR
}

enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum PlaceType {
  VILLA
  HOTEL
  RESTAURANT
  BAR
  CLUB
  TOUR
  LANDMARK
  BEACH
  ROOFTOP
  SPA
  SHOPPING
  NIGHTLIFE
}

enum ExperienceCategory {
  DINNER
  SPA
  ADVENTURE
  VIP_EVENT
  PRIVATE_TOUR
  NIGHTLIFE
  WELLNESS
  CULTURAL
  WATER_SPORTS
  GASTRONOMY
}

enum RiskLevel {
  SAFE
  CAUTION
  AVOID
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum BudgetLevel {
  BUDGET
  MODERATE
  LUXURY
  ULTRA_LUXURY
}

enum ItineraryItemStatus {
  PLANNED
  BOOKED
  DONE
  CANCELED
}

enum EntityType {
  PLACE
  EXPERIENCE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELED
  FAILED
  COMPLETED
}

enum PaymentStatus {
  INITIATED
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  ADYEN
  DUMMY
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  REJECTED
}

enum MediaType {
  IMAGE
  VIDEO
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  phone        String?
  passwordHash String
  role         UserRole  @default(TRAVELER)
  status       UserStatus @default(ACTIVE)
  lastLoginAt  DateTime?
  country      String?
  locale       String    @default("es-MX")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  profile              TravelerProfile?
  trips                Trip[]
  messages             Message[]
  conversationSessions ConversationSession[]
  recommendations      Recommendation[]
  bookings             Booking[]
  reviews              Review[]
  eventLogs            EventLog[]

  @@index([email])
  @@index([role, status])
  @@map("users")
}

model TravelerProfile {
  id            String         @id @default(uuid())
  userId        String         @unique
  fullName      String
  birthdate     DateTime?
  gender        Gender?
  homeAirport   String?
  preferences   Json?          // { cuisines: [], activities: [], ambiance: [] }
  riskTolerance RiskTolerance  @default(MEDIUM)
  loyaltyTier   LoyaltyTier    @default(BRONZE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("traveler_profiles")
}

// ============================================
// PARTNERS
// ============================================

model Partner {
  id           String        @id @default(uuid())
  type         PartnerType
  name         String
  contactEmail String
  phone        String?
  website      String?
  status       PartnerStatus @default(PENDING)
  partnerSince DateTime      @default(now())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  locations PartnerLocation[]
  bookings  Booking[]

  @@index([type, status])
  @@map("partners")
}

model PartnerLocation {
  id            String   @id @default(uuid())
  partnerId     String
  placeId       String?  @unique
  address       String
  lat           Float
  lng           Float
  openingHours  Json?    // { monday: { open: "09:00", close: "22:00" }, ... }
  avgPriceLevel Int?     // 1-4
  verified      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  place   Place?  @relation(fields: [placeId], references: [id])

  @@index([partnerId])
  @@index([lat, lng])
  @@map("partner_locations")
}

// ============================================
// CATALOG: PLACES & EXPERIENCES
// ============================================

model Place {
  id          String    @id @default(uuid())
  type        PlaceType
  name        String
  description String?
  address     String
  lat         Float
  lng         Float
  city        String
  country     String
  images      Json?     // [{ url, alt }]
  tags        String[]  @default([])
  safetyScore Int       @default(50) // 0-100
  verified    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  experiences      Experience[]
  menuItems        MenuItem[]
  media            Media[]           @relation("PlaceMedia")
  itineraryItems   ItineraryItem[]   @relation("PlaceItinerary")
  bookings         Booking[]         @relation("PlaceBooking")
  reviews          Review[]          @relation("PlaceReview")
  partnerLocation  PartnerLocation?

  @@index([type, city, country])
  @@index([lat, lng])
  @@index([safetyScore])
  @@index([verified])
  @@map("places")
}

model Experience {
  id                 String              @id @default(uuid())
  placeId            String?
  title              String
  shortDesc          String
  longDesc           String?
  category           ExperienceCategory
  durationMins       Int?
  priceMin           Float
  priceMax           Float?
  currency           String              @default("MXN")
  includes           Json?               // [{ item: "..." }]
  requirements       Json?               // { minAge: 18, maxGuests: 10 }
  cancellationPolicy Json?
  ratingAvg          Float?              @default(0)
  ratingCount        Int                 @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  place          Place?          @relation(fields: [placeId], references: [id], onDelete: SetNull)
  media          Media[]         @relation("ExperienceMedia")
  itineraryItems ItineraryItem[] @relation("ExperienceItinerary")
  bookings       Booking[]       @relation("ExperienceBooking")
  reviews        Review[]        @relation("ExperienceReview")

  @@index([category, priceMin, priceMax])
  @@index([placeId])
  @@index([ratingAvg])
  @@map("experiences")
}

model MenuItem {
  id          String   @id @default(uuid())
  placeId     String
  title       String
  description String?
  price       Float
  currency    String   @default("MXN")
  dietaryTags String[] @default([]) // ["vegetarian", "gluten-free"]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  place Place @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@index([placeId])
  @@map("menu_items")
}

model Media {
  id         String     @id @default(uuid())
  entityType EntityType
  entityId   String
  mediaType  MediaType  @default(IMAGE)
  url        String
  alt        String?
  order      Int        @default(0)
  createdAt  DateTime   @default(now())

  place      Place?      @relation("PlaceMedia", fields: [entityId], references: [id], onDelete: Cascade, map: "media_place_fk")
  experience Experience? @relation("ExperienceMedia", fields: [entityId], references: [id], onDelete: Cascade, map: "media_experience_fk")

  @@index([entityType, entityId])
  @@map("media")
}

// ============================================
// SAFETY
// ============================================

model SafetyZone {
  id             String      @id @default(uuid())
  city           String
  country        String      @default("Mexico")
  polygon        String      // GeoJSON string
  riskLevel      RiskLevel
  source         String?     // "government", "local_police", etc
  lastReviewedAt DateTime    @default(now())
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  alerts SafetyAlert[]

  @@index([city, country])
  @@index([riskLevel])
  @@map("safety_zones")
}

model SafetyAlert {
  id       String        @id @default(uuid())
  zoneId   String?
  title    String
  message  String
  severity AlertSeverity
  startAt  DateTime      @default(now())
  endAt    DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  zone SafetyZone? @relation(fields: [zoneId], references: [id], onDelete: SetNull)

  @@index([zoneId])
  @@index([severity, startAt, endAt])
  @@map("safety_alerts")
}

// ============================================
// TRIPS & ITINERARY
// ============================================

model Trip {
  id          String      @id @default(uuid())
  userId      String
  title       String
  city        String
  country     String
  startDate   DateTime
  endDate     DateTime
  partySize   Int         @default(1)
  budgetLevel BudgetLevel @default(MODERATE)
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  itineraryItems ItineraryItem[]
  messages       Message[]

  @@index([userId])
  @@index([startDate, endDate])
  @@map("trips")
}

model ItineraryItem {
  id         String              @id @default(uuid())
  tripId     String
  dayIndex   Int                 // 0-based day number
  startTime  DateTime?
  endTime    DateTime?
  entityType EntityType
  entityId   String
  status     ItineraryItemStatus @default(PLANNED)
  customNote String?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  trip       Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  place      Place?      @relation("PlaceItinerary", fields: [entityId], references: [id], onDelete: Cascade, map: "itinerary_place_fk")
  experience Experience? @relation("ExperienceItinerary", fields: [entityId], references: [id], onDelete: Cascade, map: "itinerary_experience_fk")

  @@index([tripId, dayIndex])
  @@index([entityType, entityId])
  @@map("itinerary_items")
}

// ============================================
// RECOMMENDATIONS
// ============================================

model Recommendation {
  id           String   @id @default(uuid())
  userId       String
  context      Json     // { city, budgetLevel, preferences, etc }
  items        Json     // [{ entityType, entityId, score, reasons }]
  modelVersion String   @default("v1")
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("recommendations")
}

// ============================================
// BOOKINGS & PAYMENTS
// ============================================

model Booking {
  id          String        @id @default(uuid())
  userId      String
  entityType  EntityType
  entityId    String
  partnerId   String?
  status      BookingStatus @default(PENDING)
  quantity    Int           @default(1)
  price       Float
  currency    String        @default("MXN")
  externalRef String?       // External booking reference
  meta        Json?         // { dateTime, guestNames, etc }
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner    Partner?    @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  place      Place?      @relation("PlaceBooking", fields: [entityId], references: [id], onDelete: Cascade, map: "booking_place_fk")
  experience Experience? @relation("ExperienceBooking", fields: [entityId], references: [id], onDelete: Cascade, map: "booking_experience_fk")
  payments   Payment[]

  @@index([userId, status])
  @@index([entityType, entityId])
  @@map("bookings")
}

model Payment {
  id          String          @id @default(uuid())
  bookingId   String
  amount      Float
  currency    String          @default("MXN")
  status      PaymentStatus   @default(INITIATED)
  provider    PaymentProvider @default(DUMMY)
  providerRef String?
  receiptUrl  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status, provider])
  @@map("payments")
}

// ============================================
// CHAT & MESSAGING
// ============================================

model Message {
  id          String      @id @default(uuid())
  tripId      String?
  userId      String?
  sessionId   String?
  role        MessageRole
  content     String      // TEXT content
  attachments Json?       // [{ type, url }]
  meta        Json?       // AI metadata, tokens, model version
  createdAt   DateTime    @default(now())

  trip    Trip?                @relation(fields: [tripId], references: [id], onDelete: SetNull)
  user    User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  session ConversationSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([tripId])
  @@index([userId])
  @@index([sessionId, createdAt])
  @@map("messages")
}

model ConversationSession {
  id            String    @id @default(uuid())
  userId        String
  context       Json?     // { city, currentTrip, preferences }
  active        Boolean   @default(true)
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId, active])
  @@map("conversation_sessions")
}

// ============================================
// REVIEWS & FEEDBACK
// ============================================

model Review {
  id         String       @id @default(uuid())
  userId     String
  entityType EntityType
  entityId   String
  rating     Int          // 1-5
  title      String?
  body       String?
  photos     Json?        // [{ url, alt }]
  status     ReviewStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  place      Place?      @relation("PlaceReview", fields: [entityId], references: [id], onDelete: Cascade, map: "review_place_fk")
  experience Experience? @relation("ExperienceReview", fields: [entityId], references: [id], onDelete: Cascade, map: "review_experience_fk")

  @@index([userId])
  @@index([entityType, entityId, status])
  @@index([rating])
  @@map("reviews")
}

// ============================================
// TELEMETRY & EVENT LOGS
// ============================================

model EventLog {
  id        String   @id @default(uuid())
  userId    String?
  type      String   // "page_view", "search", "booking_attempt", etc
  payload   Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type, createdAt])
  @@index([userId])
  @@map("event_logs")
}
